Формат единого файла хранения программного обеспечения
======================================================

## Назначение и описание
Sfp-файл используется для хранения нескольких образов прошивки (например, для двух полукомплектов изделия) и метаинформации, содержащий данные о версии и назначении ПО в виде единой и неделимой сущности. Так же .sfp-файл предоставляет универсальный и расширяемый способ хранения прошивок для различных типов устройств.

Sfp-файл содержит один или несколько *компонентов*. Каждый компонент заключает в себе образ прошивки для одной или нескольких целей программирования. Для каждого компонента указана одна или несколько целей прошивки. Цель прошивки определяется следующими параметрами: тип изделия, номер модификации, номер программного модуля, номер канала ("полукомплект").

Помимо компонентов sfp-файл содержит *xml-метаинформацию* о прошивке, которая представляет расширяемый набор полей, описывающих содержимое файла.

На данный момент, помимо технической информации, sfp-файл содержит информацию о:

* Номере версии и подверсии
* Текстовую метку версии
* Дату сборки ПО
* Уникальный GUID-идентификатор sfp-файла

В будущем планируется внедрение таких полей, как:

 * Электронная подпись пакета
 * ФИО и электронная почта автора ПО
 * Текстовое описание файла

## Структура файла
Sfp-файл представляет из себя zip-архив следующей структуры: в корне архива находится файл метаинформации с именем `index.xml` и папки с содержимым компонентов. Название папки компонента не является существенным и обычно выбирается случайным образом (важно лишь, чтобы название совпадало с названием, используемым в `index.xml`).
```
.
+-- [component-1]
|   +-- file-1.dat
|   +-- file-2.exe
+-- [component-2]
|   +-- file-1.dat
|   +-- file-2.exe
+-- index.xml
```
Содержимое папки компонента полностью соответствует содержимому прошивки согласно *соглашению именования файлов*.

## Соглашения именования файлов
Не смотря на то, что каждый тип устройства имеет свою модель памяти (одна или несколько областей памяти, наличие и тип файловой системы и т.д.), содержимое компонента представляется классической древовидной файловой структурой. Однако, для каждого типа устройств существуют свои соглашения по расположению и именованию файлов.

### Устройства с непрерывной памятью (AVR, ARM, ...)
Для устройств, память которых представляет непрерывную байтовую область, каждый файл должен находиться в папке, название которой соответствует типу памяти и иметь имя, соответствующее адресу начала данных, хранимых в этом файле, записанное в шестнадцатеричном виде (без расширения и ведущих `0x`). Соответствие имени папки типу памяти определяется отдельно соглашениями между загрузчиком и обслуживаемыми им модулями и являющегося частью *среды исполнения*. Например, традиционно, путь `./f/` соответствует встроенной flash-памяти микроконтроллера; `./e/` соответствует EEPROM-памяти для микроконтроллеров AVR. В экзотических случаях, например, когда в устройстве есть программируемый сопроцессор, память сопроцессора может быть представлена отдельной папкой компонента.

### Устройства на операционной системе Linux
Для устройств на ОС Linux содержимое папки компонента полностью соответствует содержимому папки `/bin` программного модуля. Атрибуты файлов (в том числе, специфичные для файловой системы yaffs2) хранятся в файле `attributes.xml` в корне компонента. XML-схема файла `attributes.xml` с описанием структуры и всех полей находится по адресу https://repo.nposaut.ru/schemas/sfp-attributes.xsd. Подключение схемы к файлу облегчит его редактирование.

Пример файла `attributes.xml`:
```xml
<Attributes xmlns="https://repo.nposaut.ru/schemas/sfp-attributes.xsd">
	<SetPremissions File="start" Premissions="750" />
	<SetPremissions File="deploy" Premissions="750" />
	<SetPremissions File="FudpLoader.Application.exe" Premissions="750" />
	<SetPremissions File="FudpLoader-restarter" Premissions="750" />
</Attributes>
```
Для каждого файла, права доступа которого требуется установить создаётся по элементу 'SetPremissions', содержащему путь к файлу в Linux-формате (с использованием `/` в качестве разделителя) и стандартное для Linux-систем hex-обозначение прав доступа. Для остальных файлов будут установлены права доступа по-умолчания.

### Устройства на базе операционной системы Windows
Для устройств на ОС Windows содержимое папки компонента полностью соответствует содержимому папки программного модуля.

## Формат файла метаинформации
Метаинформация sfp-файла содержится в файле `index.xml`. XSD-схема документа доступна по адресу https://repo.nposaut.ru/schemas/sfp-index.xsd.

Пример файла `index.xml`:
```xml
<FirmwareInfo FormatVersion="3" FormatCompatibleVersion="1">
  <FirmwareInformation Guid="72b36887-597b-4296-8acd-55d15a0474eb">
    <Version Major="3" Minor="10" Label="DZR" ReleaseDate="2015-07-10 00:00:00Z" />
  </FirmwareInformation>
  <Component Directory="a4721f83-ceb4-45fd-a5f3-e4d3e9bb8485">
    <TargetModule System="1" Cell="20" Modification="1" Channel="1" Module="1" />
    <TargetModule System="1" Cell="20" Modification="1" Channel="2" Module="1" />
  </Component>
</FirmwareInfo>
```
Корневым элементом здесь является элемент `FirmwareInfo`, который содержит атрибуты `FormatVersion`, говорящий о версии формата этого файла и `FormatCompatibleVersion`, говорящий о минимальной совместимой с этим файлом версии формата.

Элемент `FirmwareInformation` содержит информацию о прошивке в целом: аттрибут `GUID`, содержащий *GUID* (уникальный, случайно генерируемый идентификатор прошивки) и элемент `Version`, содержащий информацию о версии прошивки. В дальнейшем планируется расширять этот раздел файла дополнительной информацией о прошивке. Такой, как сведения об авторе ПО, подпись и другие.

Для каждого компонента прошивки создаётся соответствующий элемент `Component` с атрибутом `Directory`, в который записывается название директории с компонентом и список целей этого компонента.
